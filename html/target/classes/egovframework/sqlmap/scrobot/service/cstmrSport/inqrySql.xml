<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="inqrySql">

	<!-- 1:1 문의 글 삭제되지 않은 전체 갯수 조회 -->
	<select id="getUserInqryCount" resultType="Integer">
		SELECT
			COUNT(*) AS COUNT_NUM
		FROM
			INQRY_BBS
		WHERE
			DEL_YN = "N"
		AND
			MBR_ID = #{MBR_ID}
	</select>
	
	<!-- 1:1 문의 삭제되지 않은 글 중 내 글과 답글 갯수 조회 -->
	<select id="getUserInqryCountId" parameterType="Map" resultType="Integer">
		SELECT
			COUNT(*) AS COUNT_NUM
		FROM
			INQRY_BBS
		WHERE
			DEL_YN = "N"
		AND
			MBR_ID = #{MBR_ID}
		OR
			G_PRT_BBSCTT_NO IN((SELECT BBSCTT_NO FROM INQRY_BBS WHERE MBR_ID = #{MBR_ID}))
	</select>
	
	
	<!-- 1:1 문의 조회
		내가 쓴 글만 조회됨!
	 -->
	<select id="selectUserInqryList" parameterType="Map" resultType="HashMap">
	WITH RECURSIVE CTE AS 
	(
		SELECT 
			1 AS LEVEL
		,	BBSCTT_NO	
		,	MBR_ID	
		,	PRT_BBSCTT_NO
		,   BBSCTT_TY		
		,	BBSCTT_SJ	
		,	BBSCTT_CN	
		,	(CASE
				WHEN MDFR IS NULL THEN WRTER
				WHEN MDFR IS NOT NULL THEN MDFR
			END ) AS WRTER	
		,	(CASE
				WHEN MDFCN_YMD IS NULL THEN WRT_YMD
				WHEN MDFCN_YMD IS NOT NULL THEN MDFCN_YMD
			END ) AS WRT_YMD		
		,	DEL_YN	
		,	VIEWS	
		,   (CASE
				WHEN PRT_BBSCTT_NO IS NULL AND G_PRT_BBSCTT_NO IS NULL THEN BBSCTT_NO
				WHEN G_PRT_BBSCTT_NO IS NOT NULL THEN G_PRT_BBSCTT_NO
				END
			) AS COLGROUP
		,	G_PRT_BBSCTT_NO
		,(SELECT COUNT(BBSCTT_NO) FROM MP_FILE B WHERE BBSCTT_NO = B.BBSCTT_NO AND DEL_YN = "N") AS MP_FILE_CNT
		FROM INQRY_BBS
		WHERE PRT_BBSCTT_NO IS NULL 
		
		UNION ALL
		
		SELECT 
			C.LEVEL + 1 AS LEVEL
		,	A.BBSCTT_NO	
		,	A.MBR_ID	
		,	A.PRT_BBSCTT_NO
		,	A.BBSCTT_TY	
		,	(CASE
				WHEN LEVEL >= 1 THEN CONCAT(CONCAT(REPEAT('  ', LEVEL) , 'ㄴ') , A.BBSCTT_SJ )
				ELSE A.BBSCTT_SJ 
				END
			) AS BBSCTT_SJ
		,	A.BBSCTT_CN	
		,	(CASE
				WHEN A.MDFR IS NULL THEN A.WRTER
				WHEN A.MDFR IS NOT NULL THEN A.MDFR
			END ) AS WRTER	
		,	(CASE
				WHEN A.MDFCN_YMD IS NULL THEN A.WRT_YMD
				WHEN A.MDFCN_YMD IS NOT NULL THEN A.MDFCN_YMD
			END ) AS WRT_YMD		
		,	A.DEL_YN	
		,	A.VIEWS	
		,   (CASE
				WHEN A.PRT_BBSCTT_NO IS NULL AND A.G_PRT_BBSCTT_NO IS NULL THEN A.BBSCTT_NO
				WHEN A.G_PRT_BBSCTT_NO IS NOT NULL THEN A.G_PRT_BBSCTT_NO
				END
			) AS COLGROUP
		,	A.G_PRT_BBSCTT_NO
		,(SELECT COUNT(BBSCTT_NO) FROM MP_FILE B WHERE A.BBSCTT_NO = B.BBSCTT_NO AND DEL_YN = "N") AS MP_FILE_CNT
		FROM INQRY_BBS A INNER JOIN CTE C
		
		ON A.PRT_BBSCTT_NO = C.BBSCTT_NO
	)
	select * from (
		SELECT
			 FORMAT(@ROWNUM := @ROWNUM-1, 0) AS NUMROW
		,	C.BBSCTT_NO	
		,	C.MBR_ID	
		,	C.PRT_BBSCTT_NO
		,	C.BBSCTT_TY		
		,   C.BBSCTT_SJ  
		,	C.BBSCTT_CN	
		,	C.WRTER	
		,	DATE_FORMAT(C.WRT_YMD,'%Y.%m.%d') AS WRT_YMD
		,	C.DEL_YN	
		,	C.VIEWS	
		,   C.LEVEL 
		,   C.COLGROUP
		,	C.G_PRT_BBSCTT_NO
		,	(SELECT COUNT(BBSCTT_NO) FROM MP_FILE B WHERE C.BBSCTT_NO = B.BBSCTT_NO AND DEL_YN = "N") AS MP_FILE_CNT
		FROM CTE C , (SELECT @ROWNUM:=(SELECT COUNT(*) FROM INQRY_BBS WHERE DEL_YN = 'N')+1) TEMP
		WHERE
			DEL_YN = 'N'
		AND
			MBR_ID = #{MBR_ID}
		OR
			C.G_PRT_BBSCTT_NO IN (SELECT BBSCTT_NO FROM INQRY_BBS WHERE MBR_ID = #{MBR_ID})
		ORDER BY CONVERT(COLGROUP,INT) DESC , CAST(BBSCTT_NO AS UNSIGNED) ASC
			
	)D
	<![CDATA[
	WHERE 1=1
	OR NUMROW <=#{maxNum}-(#{pageNum}-1)*10
	OR NUMROW>=#{maxNum}-(#{pageNum}-1)*10-9
	]]>
	</select>
	
	<!--  1:1 문의 상세 조회 -->
	<select id="selectUserInqryDetail" parameterType="Map" resultType="HashMap">
		SELECT
			BBSCTT_NO
		,	MBR_ID
		,	PRT_BBSCTT_NO
		,	BBSCTT_TY
		,	BBSCTT_SJ
		,	BBSCTT_CN
		,	(CASE
				WHEN MDFR IS NULL THEN WRTER
				WHEN MDFR IS NOT NULL THEN MDFR
			END
			) WRTER
		,	(CASE
				WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
				WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
			END
			) WRT_YMD
		,	DEL_YN
		,	VIEWS
		,	G_PRT_BBSCTT_NO
		FROM
			INQRY_BBS
		WHERE
			DEL_YN = "N"
		AND
			BBSCTT_NO = #{BBSCTT_NO}
	</select>

		<!-- 1:1 문의 글 전체 갯수 + 1  조회 -->
	<select id="getInqryBbsCount" resultType="Integer">
		SELECT
			COUNT(*) + 1
		FROM
			INQRY_BBS
	</select>
	
			<!-- 1:1 문의 글 등록  -->
	<insert id="insertUserInqry" parameterType="Map">
		INSERT INTO INQRY_BBS
		( BBSCTT_NO
		 , MBR_ID
		 , BBSCTT_SJ
		 , BBSCTT_CN
		 , BBSCTT_TY
		 , WRT_YMD
		 , WRTER
		 , VIEWS
		 )
		 VALUES
		(
		 #{BBSCTT_NO}
		,#{MBR_ID}
		,#{BBSCTT_SJ}
		,#{BBSCTT_CN}
		,#{BBSCTT_TY}
		,NOW()
		,#{MBR_NM}
		,"0"
		)
	</insert>
	
			<!-- 1:1 문의 글 root 글에 답변   -->
	<insert id="insertUserInqryRootComment" parameterType="Map">
		INSERT INTO INQRY_BBS VALUES
		(
		 #{BBSCTT_NO}
		,#{MBR_ID}
		,#{PRT_BBSCTT_NO}
		,#{BBSCTT_TY}
		,#{BBSCTT_SJ}
		,#{BBSCTT_CN}
		,#{MBR_NM}
		,SYSDATE()
		,NULL
		,NULL
		,"N"
		,0
		,#{G_PRT_BBSCTT_NO}
		)
	</insert>
	
				<!-- 1:1 문의 글 등록  root 이외 글에 답변  -->
	<insert id="insertUserInqryNotRootComment" parameterType="Map">
		INSERT INTO INQRY_BBS VALUES
		(
		 #{BBSCTT_NO}
		,#{MBR_ID}
		,#{PRT_BBSCTT_NO}
		,#{BBSCTT_TY}
		,#{BBSCTT_SJ}
		,#{BBSCTT_CN}
		,#{MBR_NM}
		,SYSDATE()
		,NULL
		,NULL
		,"N"
		,0
		,#{G_PRT_BBSCTT_NO}
		)
	</insert>
	
	<!-- 1:1 문의 조회수 증가 기능 -->
	<select id="updateUserInqryViews" parameterType="Map">
		UPDATE INQRY_BBS SET VIEWS = #{VIEWS} WHERE BBSCTT_NO = #{BBSCTT_NO} 
	</select>
	
</mapper>














