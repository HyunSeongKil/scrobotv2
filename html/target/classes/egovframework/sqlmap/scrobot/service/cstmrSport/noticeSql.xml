<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="noticeSql">
	
	<!-- 공지사항 목록 기본 조회 -->
	<select id="selectUserNoticeList" parameterType="Map" resultType ="HashMap">
	<![CDATA[
		SELECT
			S.*
		FROM
			(
				SELECT
					 FORMAT(@ROWNUM := @ROWNUM-1, 0) AS NUMROW
					,BBSCTT_NO	
					,MBR_ID	
					,BBSCTT_TY	
					,BBSCTT_SJ	
					,BBSCTT_CN	
					,(CASE
						WHEN MDFR IS NULL THEN WRTER
						WHEN MDFR IS NOT NULL THEN MDFR
						END
					) WRTER
					,(CASE
						WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
						WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
						END
					) WRT_YMD
					,DEL_YN	
					,VIEWS	
					,POST_FIX_YN	
					,(SELECT COUNT(BBSCTT_NO) FROM MP_FILE B WHERE A.BBSCTT_NO = B.BBSCTT_NO AND DEL_YN = "N") AS MP_FILE_CNT
				FROM
					BBS A
				, 	(select @ROWNUM:=${maxNum}+1) temp
				WHERE
					1=1
				AND
					BBSCTT_TY = 'N01'
				AND
					DEL_YN = "N" 
				ORDER BY POST_FIX_YN DESC , WRT_YMD DESC , BBSCTT_NO DESC
			)S
		WHERE 1=1 
		AND NUMROW <=#{maxNum}-(#{pageNum}-1)*10
		AND NUMROW>=#{maxNum}-(#{pageNum}-1)*10-9
	]]>
	</select>
	
	<!-- 공지사항 목록 검색 조회 -->
	<select id="selectUserNoticeSearchList" parameterType="Map" resultType ="HashMap">
	<![CDATA[
	SELECT  
		D.*
	FROM (
		SELECT
			FORMAT(@ROWNUM := @ROWNUM-1, 0) AS NUMROW 
			, S.*
		FROM
			(SELECT
				BBSCTT_NO	
				,MBR_ID	
				,BBSCTT_TY	
				,BBSCTT_SJ	
				,BBSCTT_CN	
				,(CASE
					WHEN MDFR IS NULL THEN WRTER
					WHEN MDFR IS NOT NULL THEN MDFR
					END
				) WRTER
				,(CASE
					WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
					WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
					END
				) WRT_YMD
				,DEL_YN	
				,VIEWS	
				,POST_FIX_YN	
				,(SELECT COUNT(BBSCTT_NO) FROM MP_FILE B WHERE A.BBSCTT_NO = B.BBSCTT_NO AND DEL_YN = "N") AS MP_FILE_CNT
			FROM
				BBS A
			WHERE
				1=1
			AND
				BBSCTT_TY = 'N01'
			AND
				DEL_YN = "N"
			ORDER BY POST_FIX_YN DESC , WRT_YMD DESC , BBSCTT_NO DESC
		)S 
		,(select @ROWNUM:=${maxNum}+1) temp
	WHERE 1=1
	]]>
	 <if test="from != null">
	AND 
		<![CDATA[
		DATE_FORMAT(WRT_YMD,'%Y.%m.%d') >= #{from}
		]]>
	</if>
	<if test="to != null">
	AND 
		<![CDATA[
		DATE_FORMAT(WRT_YMD,'%Y.%m.%d') <= #{to}
		]]>
	</if>
	<if test="SearchStr != null and SearchType != null">
	<if test="SearchType == '전체'">
	AND
	(	BBSCTT_SJ LIKE '%/${SearchStr}%' ESCAPE '/'
	OR
		BBSCTT_CN LIKE '%/${SearchStr}%' ESCAPE '/'
	)
	 </if> 
	 <if test="SearchType == '제목'">
	AND
		BBSCTT_SJ LIKE '%/${SearchStr}%' ESCAPE '/'
	 </if>
	 <if test="SearchType == '내용'">
	AND
		BBSCTT_CN LIKE '%/${SearchStr}%' ESCAPE '/'
	 </if>
	 </if>
	 ORDER BY POST_FIX_YN DESC , WRT_YMD DESC , BBSCTT_NO DESC
	)D
	<![CDATA[
	WHERE 1=1
	AND NUMROW <=#{maxNum}-(#{pageNum}-1)*10
	AND NUMROW>=#{maxNum}-(#{pageNum}-1)*10-9
	]]>
	
	</select>
	
	<!-- 공지사항 전체 글 목록 갯수 조회 -->
	<select id="getUserNoticeCount" resultType ="Integer">
		SELECT 
			COUNT(*) AS COUNT_NUM 
		FROM
			BBS 
		WHERE 
			BBSCTT_TY = "N01" 
		AND
			DEL_YN = "N"
	</select>
	
	<!-- 공지사항 검색 조건 적용 전체 글 조회 -->
	<select id="getUserNoticeSearchCount" resultType ="Integer">
	<![CDATA[
	SELECT 
		COUNT(*) 
	FROM
		(
		SELECT
			S.*
		FROM
			(
			SELECT
				 FORMAT(@ROWNUM := @ROWNUM-1, 0) AS NUMROW
				,BBSCTT_NO	
				,MBR_ID	
				,BBSCTT_TY	
				,BBSCTT_SJ	
				,BBSCTT_CN	
				,(CASE
					WHEN MDFR IS NULL THEN WRTER
					WHEN MDFR IS NOT NULL THEN MDFR
					END
				) WRTER
				,(CASE
					WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
					WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
					END
				) WRT_YMD
				,DEL_YN	
				,VIEWS	
				,POST_FIX_YN	
				,(SELECT COUNT(BBSCTT_NO) FROM MP_FILE B WHERE A.BBSCTT_NO = B.BBSCTT_NO AND DEL_YN = "N") AS MP_FILE_CNT
			FROM
				BBS A
			, 	(select @ROWNUM:=	(SELECT
 										COUNT(*)
 									FROM
 										(SELECT 
						 					(CASE
											WHEN MDFR IS NULL THEN WRTER
											WHEN MDFR IS NOT NULL THEN MDFR
											END
											) WRTER
											,(CASE
											WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
											WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
											END
											) WRT_YMD
											, BBSCTT_SJ
											, BBSCTT_CN
										FROM 
											BBS 
										WHERE 1=1
										AND BBSCTT_TY='N01' 
										AND DEL_YN = 'N'
										)AB
									WHERE
										1=1
		]]>
									<if test="from != null">
	AND 
		<![CDATA[
		DATE_FORMAT(WRT_YMD,'%Y.%m.%d') >= #{from}
		]]>
	</if>
	<if test="to != null">
	AND 
		<![CDATA[
		DATE_FORMAT(WRT_YMD,'%Y.%m.%d') <= #{to}
		]]>
	</if>
	 <if test="SearchStr != null and SearchType != null">
	<if test="SearchType == '전체'">
	AND
	(	BBSCTT_SJ LIKE '%/${SearchStr}%' ESCAPE '/'
	OR
		BBSCTT_CN LIKE '%/${SearchStr}%' ESCAPE '/'
	)
	 </if> 
	 <if test="SearchType == '제목'">
	AND
		BBSCTT_SJ LIKE '%/${SearchStr}%' ESCAPE '/'
	 </if>
	 <if test="SearchType == '내용'">
	AND
		BBSCTT_CN LIKE '%/${SearchStr}%' ESCAPE '/'
	 </if>
	 </if>
		<![CDATA[
									)+1) temp
			WHERE
				1=1
			AND
				BBSCTT_TY = 'N01'
			AND
				DEL_YN = "N"
			ORDER BY POST_FIX_YN DESC , WRT_YMD DESC , BBSCTT_NO DESC
			)S
			WHERE 
				1=1
		]]>
		 <if test="from != null">
	AND 
		<![CDATA[
		DATE_FORMAT(WRT_YMD,'%Y.%m.%d') >= #{from}
		]]>
	</if>
	<if test="to != null">
	AND 
		<![CDATA[
		DATE_FORMAT(WRT_YMD,'%Y.%m.%d') <= #{to}
		]]>
	</if>
	  <if test="SearchStr != null and SearchType != null">
	<if test="SearchType == '전체'">
	AND
	(	BBSCTT_SJ LIKE '%/${SearchStr}%' ESCAPE '/'
	OR
		BBSCTT_CN LIKE '%/${SearchStr}%' ESCAPE '/'
	)
	 </if> 
	 <if test="SearchType == '제목'">
	AND
		BBSCTT_SJ LIKE '%/${SearchStr}%' ESCAPE '/'
	 </if>
	 <if test="SearchType == '내용'">
	AND
		BBSCTT_CN LIKE '%/${SearchStr}%' ESCAPE '/'
	 </if>
	 </if>
	     )D
		
	</select>
	
	<!-- 공지사항 상세 조회 -->
	<select id="selectUserNoticeDetail" parameterType="Map" resultType="HashMap">
		SELECT 
			BBSCTT_NO	
			,MBR_ID	
			,BBSCTT_TY	
			,BBSCTT_SJ	
			,BBSCTT_CN	
			,(CASE
				WHEN MDFR IS NULL THEN WRTER
				WHEN MDFR IS NOT NULL THEN MDFR
				END
			) WRTER
			,(CASE
				WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
				WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
				END
			) WRT_YMD
			,DEL_YN	
			,VIEWS	
			,POST_FIX_YN
		FROM
			BBS
		WHERE
			BBSCTT_TY = "N01" 
		AND
			BBSCTT_NO = #{BBSCTT_NO}  
		AND
			DEL_YN = "N"		
	</select>
	
	<!-- 공지사항 이전글 다음글 조회 -->
	<select id="selectBeforeAfterUserNoticeList" parameterType="Map" resultType ="HashMap">
SELECT
			S.*
		FROM
			(
				SELECT
					 FORMAT(@ROWNUM := @ROWNUM-1, 0) AS NUMROW
					,BBSCTT_NO	
					,MBR_ID	
					,BBSCTT_TY	
					,BBSCTT_SJ	
					,BBSCTT_CN	
					,(CASE
						WHEN MDFR IS NULL THEN WRTER
						WHEN MDFR IS NOT NULL THEN MDFR
						END
					) WRTER
					,(CASE
						WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
						WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
						END
					) WRT_YMD
					,DEL_YN	
					,VIEWS	
					,POST_FIX_YN	
					,(SELECT COUNT(BBSCTT_NO) FROM MP_FILE B WHERE A.BBSCTT_NO = B.BBSCTT_NO AND DEL_YN = "N") AS MP_FILE_CNT
				FROM
					BBS A
				, 	(select @ROWNUM:=${maxNum}+1) temp
				WHERE
					1=1
				AND
					BBSCTT_TY = 'N01'
				AND
					DEL_YN = "N" 
				ORDER BY POST_FIX_YN DESC , WRT_YMD DESC , BBSCTT_NO DESC
			)S
	WHERE 1=1
	AND NUMROW BETWEEN #{MINNUMROW} AND #{ADDNUMROW}
    AND NUMROW NOT IN (#{NUMROW})
	</select>
	
	
	<!-- 공지사항 조회수 증가 기능 -->
	<select id="updateUserNoticeViews" parameterType="Map">
		UPDATE BBS SET VIEWS = #{VIEWS} WHERE BBSCTT_NO = #{BBSCTT_NO} 
	</select>
	

</mapper>














