<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="adminNoticeSql">
	
	<!-- 공지사항 목록 기본 조회 -->
	<select id="selectAdminNoticeList" parameterType="Map" resultType ="HashMap">
	/*
	adminNoticeSql.selectAdminNoticeList*/
	<![CDATA[
		 SELECT
			S.*
		FROM
			(
				SELECT
					 FORMAT(@ROWNUM := @ROWNUM-1, 0) AS NUMROW
					,BBSCTT_NO	
					,MBR_ID	
					,BBSCTT_TY	
					,BBSCTT_SJ	
					,BBSCTT_CN	
					,(CASE
						WHEN MDFR IS NULL THEN WRTER
						WHEN MDFR IS NOT NULL THEN MDFR
						END
					) WRTER
					,(CASE
						WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
						WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
						END
					) WRT_YMD
					,DEL_YN	
					,VIEWS	
					,POST_FIX_YN	
					,(SELECT COUNT(BBSCTT_NO) FROM MP_FILE B WHERE A.BBSCTT_NO = B.BBSCTT_NO AND DEL_YN = "N") AS MP_FILE_CNT
				FROM
					BBS A
				, 	(select @ROWNUM:=${maxNum}+1) temp
				WHERE
					1=1
				AND
					BBSCTT_TY = 'N01'
				AND
					DEL_YN = "N" 
				ORDER BY POST_FIX_YN DESC , WRT_YMD DESC , BBSCTT_NO DESC
			)S
		WHERE 1=1 
		AND NUMROW <=#{maxNum}-(#{pageNum}-1)*10
		AND NUMROW>=#{maxNum}-(#{pageNum}-1)*10-9
	]]>
	</select>
	
	<!-- 공지사항 목록 검색 조회 -->
	<select id="selectAdminNoticeSearchList" parameterType="Map" resultType ="HashMap">
	<![CDATA[
	SELECT  
		D.*
	FROM (
		SELECT
			FORMAT(@ROWNUM := @ROWNUM-1, 0) AS NUMROW 
			, S.*
		FROM
			(SELECT
				BBSCTT_NO	
				,MBR_ID	
				,BBSCTT_TY	
				,BBSCTT_SJ	
				,BBSCTT_CN	
				,(CASE
					WHEN MDFR IS NULL THEN WRTER
					WHEN MDFR IS NOT NULL THEN MDFR
					END
				) WRTER
				,(CASE
					WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
					WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
					END
				) WRT_YMD
				,DEL_YN	
				,VIEWS	
				,POST_FIX_YN	
				,(SELECT COUNT(BBSCTT_NO) FROM MP_FILE B WHERE A.BBSCTT_NO = B.BBSCTT_NO AND DEL_YN = "N") AS MP_FILE_CNT
			FROM
				BBS A
			WHERE
				1=1
			AND
				BBSCTT_TY = 'N01'
			AND
				DEL_YN = "N"
			ORDER BY POST_FIX_YN DESC , WRT_YMD DESC , BBSCTT_NO DESC
		)S 
		,(select @ROWNUM:=${maxNum}+1) temp
	WHERE 1=1
	]]>
	<if test="from != null">
	AND 
		<![CDATA[
		DATE_FORMAT(WRT_YMD,'%Y.%m.%d') >= #{from}
		]]>
	</if>
	<if test="to != null">
	AND 
		<![CDATA[
		DATE_FORMAT(WRT_YMD,'%Y.%m.%d') <= #{to}
		]]>
	</if>
	<if test="SearchStr != null and SearchType != null">
	<if test="SearchType == '전체'">
	AND
	(	BBSCTT_SJ LIKE '%/${SearchStr}%' ESCAPE '/'
	OR
		BBSCTT_CN LIKE '%/${SearchStr}%' ESCAPE '/'
	)
	 </if> 
	 <if test="SearchType == '제목'">
	AND
		BBSCTT_SJ LIKE '%/${SearchStr}%' ESCAPE '/'
	 </if>
	 <if test="SearchType == '내용'">
	AND
		BBSCTT_CN LIKE '%/${SearchStr}%' ESCAPE '/'
	 </if>
	 </if>
	 ORDER BY POST_FIX_YN DESC , WRT_YMD DESC , BBSCTT_NO DESC
	)D
	<![CDATA[
	WHERE 1=1
	AND NUMROW <=#{maxNum}-(#{pageNum}-1)*10
	AND NUMROW>=#{maxNum}-(#{pageNum}-1)*10-9
	]]>
	
	</select>
	
	<!-- 공지사항 전체 글 목록 갯수 조회 -->
	<select id="getAdminNoticeCount" resultType ="Integer">
		SELECT 
			COUNT(*) AS COUNT_NUM 
		FROM
			BBS 
		WHERE 
			BBSCTT_TY = "N01" 
		AND
			DEL_YN = "N"
	</select>
	
	<!-- 공지사항 검색 조건 적용 전체 글 조회 -->
	<select id="getAdminNoticeSearchCount" parameterType="Map" resultType ="Integer">
	<![CDATA[
	SELECT 
		COUNT(*) 
	FROM
		(
		SELECT
			S.*
		FROM
			(
			SELECT
				 FORMAT(@ROWNUM := @ROWNUM-1, 0) AS NUMROW
				,BBSCTT_NO	
				,MBR_ID	
				,BBSCTT_TY	
				,BBSCTT_SJ	
				,BBSCTT_CN	
				,(CASE
					WHEN MDFR IS NULL THEN WRTER
					WHEN MDFR IS NOT NULL THEN MDFR
					END
				) WRTER
				,(CASE
					WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
					WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
					END
				) WRT_YMD
				,DEL_YN	
				,VIEWS	
				,POST_FIX_YN	
				,(SELECT COUNT(BBSCTT_NO) FROM MP_FILE B WHERE A.BBSCTT_NO = B.BBSCTT_NO AND DEL_YN = "N") AS MP_FILE_CNT
			FROM
				BBS A
			, 	(select @ROWNUM:=	(SELECT
 										COUNT(*)
 									FROM
 										(SELECT 
						 					(CASE
											WHEN MDFR IS NULL THEN WRTER
											WHEN MDFR IS NOT NULL THEN MDFR
											END
											) WRTER
											,(CASE
											WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
											WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
											END
											) WRT_YMD
											, BBSCTT_SJ
											, BBSCTT_CN
										FROM 
											BBS 
										WHERE 1=1
										AND BBSCTT_TY='N01' 
										AND DEL_YN = 'N'
										)AB
									WHERE
										1=1
		]]>
									<if test="from != null">
	AND 
		<![CDATA[
		DATE_FORMAT(WRT_YMD,'%Y.%m.%d') >= #{from}
		]]>
	</if>
	<if test="to != null">
	AND 
		<![CDATA[
		DATE_FORMAT(WRT_YMD,'%Y.%m.%d') <= #{to}
		]]>
	</if>
	 <if test="SearchStr != null and SearchType != null">
	<if test="SearchType == '전체'">
	AND
	(	BBSCTT_SJ LIKE '%/${SearchStr}%' ESCAPE '/'
	OR
		BBSCTT_CN LIKE '%/${SearchStr}%' ESCAPE '/'
	)
	 </if> 
	 <if test="SearchType == '제목'">
	AND
		BBSCTT_SJ LIKE '%/${SearchStr}%' ESCAPE '/'
	 </if>
	 <if test="SearchType == '내용'">
	AND
		BBSCTT_CN LIKE '%/${SearchStr}%' ESCAPE '/'
	 </if>
	 </if>
		<![CDATA[
									)+1) temp
			WHERE
				1=1
			AND
				BBSCTT_TY = 'N01'
			AND
				DEL_YN = "N"
			ORDER BY POST_FIX_YN DESC , WRT_YMD DESC , BBSCTT_NO DESC
			)S
			WHERE 
				1=1
		]]>
		 <if test="from != null">
	AND 
		<![CDATA[
		DATE_FORMAT(WRT_YMD,'%Y.%m.%d') >= #{from}
		]]>
	</if>
	<if test="to != null">
	AND 
		<![CDATA[
		DATE_FORMAT(WRT_YMD,'%Y.%m.%d') <= #{to}
		]]>
	</if>
	 <if test="SearchStr != null and SearchType != null">
	<if test="SearchType == '전체'">
	AND
	(	BBSCTT_SJ LIKE '%/${SearchStr}%' ESCAPE '/'
	OR
		BBSCTT_CN LIKE '%/${SearchStr}%' ESCAPE '/'
	)
	 </if> 
	 <if test="SearchType == '제목'">
	AND
		BBSCTT_SJ LIKE '%/${SearchStr}%' ESCAPE '/'
	 </if>
	 <if test="SearchType == '내용'">
	AND
		BBSCTT_CN LIKE '%/${SearchStr}%' ESCAPE '/'
	 </if>
	 </if>
	     )D
		
	</select>
	
	<!-- 공지사항 상세 조회 -->
	<select id="selectAdminNoticeDetail" parameterType="Map" resultType="HashMap">
	
	/* adminNoticeService.selectAdminNoticeDetail */
		SELECT 
			BBSCTT_NO	
			,MBR_ID	
			,BBSCTT_TY	
			,BBSCTT_SJ	
			,BBSCTT_CN	
			,(CASE
				WHEN MDFR IS NULL THEN WRTER
				WHEN MDFR IS NOT NULL THEN MDFR
				END
			) WRTER
			,(CASE
				WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
				WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
				END
			) WRT_YMD
			,DEL_YN	
			,VIEWS	
			,POST_FIX_YN
		FROM
			BBS
		WHERE
			BBSCTT_TY = "N01" 
		AND
			BBSCTT_NO = #{BBSCTT_NO}  
		AND
			DEL_YN = "N"			
	</select>
	
	<!-- 공지사항 이전글 다음글 조회 -->
	<select id="selectBeforeAfterAdminNoticeList" parameterType="Map" resultType ="HashMap">
SELECT
			S.*
		FROM
			(
				SELECT
					 FORMAT(@ROWNUM := @ROWNUM-1, 0) AS NUMROW
					,BBSCTT_NO	
					,MBR_ID	
					,BBSCTT_TY	
					,BBSCTT_SJ	
					,BBSCTT_CN	
					,(CASE
						WHEN MDFR IS NULL THEN WRTER
						WHEN MDFR IS NOT NULL THEN MDFR
						END
					) WRTER
					,(CASE
						WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
						WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
						END
					) WRT_YMD
					,DEL_YN	
					,VIEWS	
					,POST_FIX_YN	
					,(SELECT COUNT(BBSCTT_NO) FROM MP_FILE B WHERE A.BBSCTT_NO = B.BBSCTT_NO AND DEL_YN = "N") AS MP_FILE_CNT
				FROM
					BBS A
				, 	(select @ROWNUM:=${maxNum}+1) temp
				WHERE
					1=1
				AND
					BBSCTT_TY = 'N01'
				AND
					DEL_YN = "N" 
				ORDER BY POST_FIX_YN DESC , WRT_YMD DESC , BBSCTT_NO DESC
			)S
	WHERE 1=1
	AND NUMROW BETWEEN #{MINNUMROW} AND #{ADDNUMROW}
    AND NUMROW NOT IN (#{NUMROW})
	</select>
	
	<!-- 공지사항 조회수 증가 기능 -->
	<select id="updateAdminNoticeViews" parameterType="Map">
		UPDATE BBS SET VIEWS = #{VIEWS} WHERE BBSCTT_NO = #{BBSCTT_NO} 
	</select>
	
	<select id="getBBSCount" resultType="Integer">
		SELECT COUNT(*)+1 FROM BBS 
	</select>
	
	<insert id="insertAdminNotice" parameterType="Map">
		INSERT INTO BBS VALUES
		(
		 #{BBSCTT_NO}
		,#{MBR_ID}
		,#{BBSCTT_TY}
		,#{BBSCTT_SJ}
		,#{BBSCTT_CN}
		,#{MBR_NM}
		,SYSDATE()
		,NULL
		,NULL
		,"N"
		,0
		,#{POST_FIX_YN}
		)

	</insert>
	
	<select id="getMpFileCount" resultType="Integer">
		SELECT COUNT(*)+1 FROM MP_FILE
	</select>
	
	<insert id="FileUpload" parameterType="Map">
		INSERT INTO MP_FILE
		VALUES
		(
		#{mpFileCnt}
		,#{BBSCTT_NO}
		,#{oriFileNm}
		,#{saveFileNm}
		,#{fileSize}
		,SYSDATE()
		,"N"
		,#{BBSCTT_TY}
		)
	</insert>
	
	
	<select id="selectAdminMpFileList" parameterType="Map" resultType="HashMap">
		SELECT FILE_NO,
		   ORG_FILE_NM,
		   ROUND(FILE_SZ/1024,1) AS FILE_SZ
	  FROM MP_FILE
	 WHERE BBSCTT_NO = #{BBSCTT_NO}
	 AND DEL_YN = "N"
	</select>
	
	<select id="selectAdminMpFile" parameterType="Map" resultType="HashMap">
		SELECT FILE_NO,
		   ORG_FILE_NM,
		   CHG_FILE_NM
	  FROM MP_FILE
	 WHERE FILE_NO = #{FILE_NO}
	 AND DEL_YN = "N"
	</select>
	
	<update id="deleteAdminNotice" parameterType="Map">
		UPDATE BBS SET DEL_YN = "Y" WHERE BBSCTT_TY = #{BBSCTT_TY} AND BBSCTT_NO = #{BBSCTT_NO}
	</update>

	<update id="deleteAdminNoticeMpFile" parameterType="Map">
		UPDATE MP_FILE SET DEL_YN = "Y" WHERE BBSCTT_NO = #{BBSCTT_NO}
	</update>
	
	<update id="updateAdminNotice" parameterType="Map">
		UPDATE 
			BBS 
		SET
			BBSCTT_SJ = #{BBSCTT_SJ} 
		,	BBSCTT_CN = #{BBSCTT_CN}
		,	POST_FIX_YN = #{POST_FIX_YN} 
		,	MDFR = #{MBR_NM}
		,	MDFCN_YMD = SYSDATE()
		,	DEL_YN = "N"
		WHERE 
			BBSCTT_NO = #{BBSCTT_NO}
	</update>
	<update id="deleteMpFileList" parameterType="Map">
		UPDATE MP_FILE SET DEL_YN = "Y" WHERE FILE_NO = #{FILE_NO}
	</update>
	
</mapper>








