<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="MessageManage">

	<!-- 메시지 갯수 조회 -->
	<select id="getMessageCount" resultType="Integer">
		/* MessageManage.getMessageCount */
		
			SELECT 
				COUNT(*) AS COUNT_NUM 
			FROM
				MESSAGE
			WHERE 
				DEL_YN = "N"
	</select>

	<!-- 메시지 목록 조회 -->
	<select id="selectMsgList" resultType="HashMap">
	
	/* MessageManage.selectMsgList */
	
	<![CDATA[
		SELECT S.*
			FROM(
				SELECT
					FORMAT(@ROWNUM := @ROWNUM-1, 0) AS NUMROW
					, MESSAGE_ID
					, MESSAGE_NM
					, MESSAGE_CN
					, (CASE
							WHEN MDFR IS NULL THEN WRTER
							WHEN MDFR IS NOT NULL THEN MDFR
							END
						) WRTER
					, (CASE
							WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
							WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
							END
						) WRT_YMD
				FROM 
					MESSAGE
					, (SELECT @ROWNUM:=${maxNum} +1) temp
				WHERE 1=1
				AND DEL_YN = 'N'
				ORDER BY MESSAGE_ID DESC
				)S
			WHERE 1=1
			AND NUMROW <=${maxNum}-(#{pageNum}-1)*10
			AND NUMROW>=${maxNum}-(#{pageNum}-1)*10-9
			;
	]]>
	
	</select>
	
	<!-- 메시지 추가 -->
	<insert id="insertMsg" parameterType="HashMap">

		/*
		MessageManage.insertMsg*/
		
		INSERT INTO
		MESSAGE
		(MESSAGE_ID,MESSAGE_NM,MESSAGE_CN,WRTER,WRT_YMD)
		SELECT
		IFNULL(MAX(MESSAGE_ID*1) + 1, 1)
		,#{MESSAGE_NM}
		,#{MESSAGE_CN}
		,#{WRTER}
		,NOW()
		FROM MESSAGE;

	</insert>


	<!-- 메시지 상세 조회 -->
	<select id="selectMsgDetail" resultType="HashMap"
		parameterType="HashMap">

		/*
		MessageManage.selectMsgDetail*/

		SELECT
		MESSAGE_ID
		,MESSAGE_NM
		,MESSAGE_CN
		,(CASE
		WHEN MDFCN_YMD IS NULL THEN
		DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
		WHEN MDFCN_YMD IS NOT NULL THEN
		DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
		END
		) WRT_YMD
		,(CASE
		WHEN MDFR IS NULL
		OR MDFR = 'NULL' THEN WRTER
		WHEN MDFR IS NOT NULL THEN MDFR
		END
		) WRTER
		FROM MESSAGE
		WHERE
		MESSAGE_ID = #{MESSAGE_ID}
		AND DEL_YN = "N"

	</select>
	
	<!-- 메시지 삭제 -->
	<update id="deleteMsg" parameterType="HashMap">

		/*
		MessageManage.deleteMsg*/
		UPDATE
		MESSAGE
		SET
		DEL_YN='Y'
		WHERE
		MESSAGE_ID =
		#{MESSAGE_ID}

	</update>
	
	<!-- 메시지 수정 -->
	<update id="updateMsg" parameterType="HashMap">

		/*
		MessageManage.updateMsg*/
		UPDATE
		MESSAGE
		SET
		MESSAGE_NM=#{MESSAGE_NM}
		,MESSAGE_CN=#{MESSAGE_CN}
		,MDFR=#{MBR_NM}
		,MDFCN_YMD=NOW()
		WHERE
		MESSAGE_ID =
		#{MESSAGE_ID}

	</update>
	
	<!-- 메시지 검색 조건 적용 전체 갯수 조회 -->
	<select id="getMsgSearchCount" parameterType="Map" resultType ="Integer">
	
	/*
		MessageManage.getMsgSearchCount*/
	<![CDATA[
	SELECT
		COUNT(*)
	FROM (
		SELECT
			 S.*
		FROM
			(SELECT
			    MESSAGE_ID,
			    MESSAGE_NM,
			    MESSAGE_CN,
			   (CASE
					WHEN MDFR IS NULL OR MDFR = 'NULL' THEN WRTER
					WHEN MDFR IS NOT NULL THEN MDFR
					END
					) WRTER,
			    (
			        CASE
			            WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD, '%Y.%m.%d')
			            WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD, '%Y.%m.%d')
			        END
			     ) WRT_YMD
				FROM MESSAGE 
			    WHERE 1 = 1
			    AND 
			    	DEL_YN = "N"
			    ORDER BY
					MESSAGE_ID DESC
					)S
			
				WHERE 1=1
			    ]]>
					<if test="from != null and to != null">
						AND
						DATE_FORMAT(WRT_YMD,'%Y.%m.%d') BETWEEN #{from} AND
						#{to}
					</if>
					<if test="from != null and to == null">
						AND
						DATE_FORMAT(WRT_YMD,'%Y.%m.%d') BETWEEN #{from} AND
						(SELECT MAX(DATE_FORMAT(WRT_YMD,'%Y.%m.%d')))
					</if>
					<if test="from == null and to != null">
						AND
						DATE_FORMAT(WRT_YMD,'%Y.%m.%d') BETWEEN(SELECT 
						MIN(DATE_FORMAT(WRT_YMD,'%Y.%m.%d'))) AND
						#{to}
					</if>
					<if test="SearchStr != null and SearchType != null">
						<if test="SearchType == 'all'.toString()">
							AND
							MESSAGE_NM LIKE '%${SearchStr}%'
							or MESSAGE_id LIKE '%${SearchStr}%'
							or MESSAGE_CN LIKE '%${SearchStr}%'
						</if>
						<if test="SearchType == 'sj'.toString()">
							AND MESSAGE_NM LIKE '%${SearchStr}%'
						</if>
						<if test="SearchType == 'id'.toString()">
							AND MESSAGE_id LIKE '%${SearchStr}%'
						</if>
						<if test="SearchType == 'cn'.toString()">
							AND MESSAGE_CN LIKE '%${SearchStr}%'
						</if>
					</if>
					ORDER BY
					MESSAGE_ID DESC
					)D
	</select>
	
	<!-- 메시지 검색 조회 -->
	<select id="selectMsgSearchList" parameterType="HashMap"
		resultType="HashMap">

		/*
		MessageManage.selectMsgSearchList*/
		<![CDATA[
	SELECT
		D.*
	FROM (
		SELECT
			 FORMAT(@ROWNUM := @ROWNUM-1, 0) AS NUMROW,
			 S.*
		FROM
			(SELECT
			    MESSAGE_NM,
			    MESSAGE_ID,
			    MESSAGE_CN,
			   (CASE
					WHEN MDFR IS NULL OR MDFR = 'NULL' THEN WRTER
					WHEN MDFR IS NOT NULL THEN MDFR
					END
					) WRTER,
			    (
			        CASE
			            WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD, '%Y.%m.%d')
			            WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD, '%Y.%m.%d')
			        END
			     ) WRT_YMD
				FROM MESSAGE A 
			    WHERE 1 = 1
			    AND 
			    	DEL_YN = "N"
			    ORDER BY
					MESSAGE_ID DESC
					)S
					,(select @ROWNUM:=${maxNum}+1) temp
				WHERE 1=1
			    ]]>
					<if test="from != null and from != ''">
					AND 
						<![CDATA[
						DATE_FORMAT(WRT_YMD,'%Y.%m.%d') >= IFNULL(#{from},'')
						]]>
					</if>
					<if test="to != null and to != ''">
					AND 
						<![CDATA[
						DATE_FORMAT(WRT_YMD,'%Y.%m.%d') <= IFNULL(#{to},'')
						]]>
					</if>
						<if test="SearchStr != null and SearchType != null">
						<if test="SearchType == 'all'.toString()">
							AND
							MESSAGE_NM LIKE '%${SearchStr}%'
							or MESSAGE_id LIKE '%${SearchStr}%'
							or MESSAGE_CN LIKE '%${SearchStr}%'
						</if>
						<if test="SearchType == 'sj'.toString()">
							AND MESSAGE_NM LIKE '%${SearchStr}%'
						</if>
						<if test="SearchType == 'id'.toString()">
							AND MESSAGE_id LIKE '%${SearchStr}%'
						</if>
						<if test="SearchType == 'cn'.toString()">
							AND MESSAGE_CN LIKE '%${SearchStr}%'
						</if>
					</if>
					ORDER BY
					MESSAGE_ID DESC
					)D
						<![CDATA[
						WHERE 1=1
						AND NUMROW <=#{maxNum}-(#{pageNum}-1)*10
						AND NUMROW>=#{maxNum}-(#{pageNum}-1)*10-9
						;
						]]>

	</select>
	
	<!-- 메시지 글 전체 갯수 + 1  조회 -->
	<select id="getMsgMaxCount" resultType="Integer">
		/*
		MessageManage.getMsgMaxCount*/
	
		SELECT
			COUNT(*) + 1
		FROM
			MESSAGE
	</select>
	
</mapper>