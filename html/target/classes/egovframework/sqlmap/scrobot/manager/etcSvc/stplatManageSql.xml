<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="stplatManage">

	<!-- 약관 목록 기본 조회 -->
	<select id="selectStplatList" resultType="HashMap">

		/*
		stplatManage.selectStplatList*/
		<![CDATA[
 SELECT
			S.*
		FROM
			(
				SELECT
					 FORMAT(@ROWNUM := @ROWNUM-1, 0) AS NUMROW
					,STPLAT_SJ
					,STPLAT_ID
					,(CASE
						WHEN MDFR IS NULL THEN WRTER
						WHEN MDFR IS NOT NULL THEN MDFR
						END
					) WRTER
					,(CASE
						WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
						WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
						END
					) WRT_YMD
					
				FROM
					STPLAT 
				, 	(select @ROWNUM:=${maxNum}+1) temp
				WHERE
					1=1
				AND
					DEL_YN = 'N' 
				ORDER BY STPLAT_ID DESC 
			)S
		WHERE 1=1 
		AND NUMROW <=${maxNum}-(#{pageNum}-1)*10
		AND NUMROW>=${maxNum}-(#{pageNum}-1)*10-9
		;
		]]>
	</select>

	<!-- 약관 상세 조회 -->
	<select id="selectStplatDetail" resultType="HashMap"
		parameterType="HashMap">

		/*
		stplatManage.selectStplatDetail*/

		SELECT
		STPLAT_SJ
		,STPLAT_ID
		,STPLAT_CN
		,(CASE
		WHEN MDFCN_YMD IS NULL THEN
		DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
		WHEN MDFCN_YMD IS NOT NULL THEN
		DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
		END
		) WRT_YMD
		,(CASE
		WHEN MDFR IS NULL
		OR MDFR = 'NULL' THEN WRTER
		WHEN MDFR IS NOT NULL THEN MDFR
		END
		) WRTER
		FROM STPLAT
		WHERE
		STPLAT_ID = #{STPLAT_ID}
		AND DEL_YN = "N"

	</select>

	<!-- 약관 추가 -->
	<insert id="insertStplat" parameterType="HashMap">

		/*
		stplatManage.insertStplat*/
		INSERT INTO
		STPLAT
		(STPLAT_ID,STPLAT_SJ,STPLAT_CN,WRTER,WRT_YMD)
		SELECT
		IFNULL(MAX(STPLAT_ID*1) + 1, 1)
		,#{STPLAT_SJ}
		,#{STPLAT_CN}
		,#{WRTER}
		,NOW()
		FROM STPLAT;

	</insert>

	<!-- 약관 삭제 -->
	<update id="deleteStplat" parameterType="HashMap">

		/*
		stplatManage.deleteStplat*/
		UPDATE
		STPLAT
		SET
		DEL_YN='Y'
		WHERE
		STPLAT_ID =
		#{STPLAT_ID}

	</update>

	<!-- 약관 수정 -->
	<update id="updateStplat" parameterType="HashMap">

		/*
		stplatManage.updateStplat*/
		UPDATE
		STPLAT
		SET
		STPLAT_SJ=#{STPLAT_SJ}
		,STPLAT_CN=#{STPLAT_CN}
		,MDFR=#{MBR_NM}
		,MDFCN_YMD=NOW()
		WHERE
		STPLAT_ID =
		#{STPLAT_ID}

	</update>

	<!-- 약관 목록 검색 조회 -->
	<select id="selectStplatSearchList" parameterType="HashMap"
		resultType="HashMap">

		/*
		stplatManage.selectStplatSearchList*/
		<![CDATA[
	SELECT
		D.*
	FROM (
		SELECT
			 FORMAT(@ROWNUM := @ROWNUM-1, 0) AS NUMROW,
			 S.*
		FROM
			(SELECT
			    STPLAT_SJ,
			    STPLAT_ID,
			   (CASE
					WHEN MDFR IS NULL OR MDFR = 'NULL' THEN WRTER
					WHEN MDFR IS NOT NULL THEN MDFR
					END
					) WRTER,
			    (
			        CASE
			            WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD, '%Y.%m.%d')
			            WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD, '%Y.%m.%d')
			        END
			     ) WRT_YMD
				FROM STPLAT A 
			    WHERE 1 = 1
			    AND 
			    	DEL_YN = "N"
			    ORDER BY
					WRT_YMD DESC
					)S
					,(select @ROWNUM:=${maxNum}+1) temp
				WHERE 1=1
			    ]]>
						<if test="SearchStr != null and SearchType != null">
						<if test="SearchType == 'all'.toString()">
							AND
						(	STPLAT_SJ LIKE '%/${SearchStr}%' ESCAPE '/'
						OR
							STPLAT_ID LIKE '%/${SearchStr}%' ESCAPE '/'
						)
						</if>
						<if test="SearchType == 'sj'.toString()">
							AND STPLAT_SJ LIKE '%${SearchStr}%'
						</if>
						<if test="SearchType == 'id'">
						AND
							STPLAT_ID LIKE '%/${SearchStr}%' ESCAPE '/'
						 </if>
						 </if>
					ORDER BY
					STPLAT_ID DESC
					)D
						<![CDATA[
						WHERE 1=1
						AND NUMROW <=#{maxNum}-(#{pageNum}-1)*10
						AND NUMROW>=#{maxNum}-(#{pageNum}-1)*10-9
						;
						]]>

	</select>
	
	<!-- 약관 전체 글 목록 갯수 조회 -->
	<select id="getStplatCount" resultType ="Integer">
		SELECT 
			COUNT(*) AS COUNT_NUM 
		FROM
			STPLAT
		WHERE 
			DEL_YN = "N"
	</select>
	
	<!-- 약관 검색 조건 적용 전체 글 갯수 조회 -->
	<select id="getStplatSearchCount" parameterType="Map" resultType ="Integer">
	
	/*
		stplatManage.getStplatSearchCount*/
	<![CDATA[
	SELECT
		COUNT(*)
	FROM (
		SELECT
			 S.*
		FROM
			(SELECT
			    STPLAT_SJ,
			    STPLAT_ID,
			   (CASE
					WHEN MDFR IS NULL OR MDFR = 'NULL' THEN WRTER
					WHEN MDFR IS NOT NULL THEN MDFR
					END
					) WRTER,
			    (
			        CASE
			            WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD, '%Y.%m.%d')
			            WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD, '%Y.%m.%d')
			        END
			     ) WRT_YMD
				FROM STPLAT 
			    WHERE 1 = 1
			    AND 
			    	DEL_YN = "N"
			    ORDER BY
					STPLAT_ID DESC
					)S
			
				WHERE 1=1
			    ]]>
					<if test="SearchStr != null and SearchType != null">
						<if test="SearchType == 'all'.toString()">
							AND
						(	STPLAT_SJ LIKE '%/${SearchStr}%' ESCAPE '/'
						OR
							STPLAT_ID LIKE '%/${SearchStr}%' ESCAPE '/'
						)
						</if>
						<if test="SearchType == 'sj'.toString()">
							AND STPLAT_SJ LIKE '%${SearchStr}%'
						</if>
						<if test="SearchType == 'id'">
						AND
							STPLAT_ID LIKE '%/${SearchStr}%' ESCAPE '/'
						 </if>
					</if>
					ORDER BY
					STPLAT_ID DESC
					)D
	</select>
		<!-- 약관 글 전체 갯수 + 1  조회 -->
	<select id="getStplatMaxCount" resultType="Integer">
		/*
		stplatManage.getStplatMaxCount*/
	
		SELECT
			COUNT(*) + 1
		FROM
			STPLAT
	</select>
	
</mapper>








