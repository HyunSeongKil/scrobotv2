<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="popPrjList">
	
	<select id="loadPrjList" parameterType="hashmap" resultType ="HashMap">
    	/* popPrjList.loadPrjList */
		/*PR.MBER_ID를 PR.MBR_ID로 수정함*/
		SELECT PR.PRJCT_ID AS PRJ_ID
			 , PR.PRJCT_NM AS PRJ_NM
			 , DATE_FORMAT(PR.STRG_DT,'%y.%m.%d %H:%i:%s') AS MAKE_DTTM
			 , COUNT(SI.SCRIN_ID) AS VIEW_CNT
		FROM T_RE_PRJ_004 PR
		LEFT OUTER JOIN T_SP_MBR_009 MB
		ON PR.MBR_ID = MB.MBR_ID
		LEFT OUTER JOIN T_RE_SIF_005 SI
		ON PR.PRJCT_ID = SI.PRJCT_ID
		WHERE PR.MBR_ID = #{USER_ID}
		GROUP BY PR.PRJCT_ID
		ORDER BY PR.STRG_DT DESC
	</select>
	
	<delete id="deletePrj" parameterType="hashmap">
		/* popPrjList.deletePrj */
		
		DELETE 
		FROM T_RE_PRJ_004
		WHERE PRJCT_ID = #{PRJ_ID}
	</delete>
	
	<insert id="insertPrj" parameterType="hashmap">
		/* popPrjList.insertPrj*/

		INSERT INTO T_RE_PRJ_004
		VALUES (
		#{PRJ_ID}
		, #{PRJ_NM}
		, SYSDATE()
		, #{USER_ID}
		, 'N'
		, 'N'
		, 'O'
		, 'mysql'
		, '192.168.0.20'
		, '8080'
		, 'root'
		, '!1q2w3e4r')
	</insert>
	
	<update id="updatePrjNm" parameterType="hashmap">
		/* popPrjList.updatePrjnm*/
		UPDATE T_RE_PRJ_004
		SET PRJCT_NM = #{PRJ_NM}
		WHERE PRJCT_ID = #{PRJ_ID}
	</update>
	
	<select id="selectPrjYn" parameterType="hashmap" resultType="HashMap">
		/* popPrjList."selectPrj"*/
	
		SELECT CASE WHEN COUNT(*) = 0
		THEN 'N'
		ELSE 'Y' END AS prjYn
		FROM T_RE_PRJ_004
		WHERE PRJCT_ID = #{PRJ_ID}
	</select>
	
	<insert id="insertMenu" parameterType="hashmap">

		/* popPrjList.insertMenu*/

		INSERT INTO MENU(
		MENU_ID
		, PRJCT_ID
		, MENU_NM
		, MENU_LVL
		, HRNK_MENU_ID
		, MENU_SEQ
		, MAKE_DTTM
		, CRTR_ID
		, VIEW_ID
		)
		VALUES (
		#{MENU_ID}
		, #{PRJCT_ID}
		, #{MENU_NM}
		, #{MENU_LVL}
		, #{HRNK_MENU_ID}
		, #{MENU_SEQ}
		, SYSDATE()
		, #{USER_ID}
		, #{VIEW_ID})
		ON
		DUPLICATE KEY UPDATE
		MENU_NM = #{MENU_NM}
		, MENU_LVL = #{MENU_LVL}
		, HRNK_MENU_ID = #{HRNK_MENU_ID}
		, MENU_SEQ = #{MENU_SEQ}
		, MAKE_DTTM = SYSDATE()
		, CRTR_ID = #{USER_ID}
		, VIEW_ID = #{VIEW_ID}

	</insert>
	
	<update id="updateViewInfo" parameterType="hashmap">
		/* popPrjList.updateViewInfo */
		
		UPDATE MENU
		SET VIEW_ID = #{VIEW_ID}
		, CRTR_ID = #{USER_ID}
	
		WHERE PRJCT_ID = #{PRJ_ID}
		AND MENU_ID = #{MENU_ID}
	</update>
	
	<update id="updateViewInfo_deleted" parameterType="hashmap">
		/* popPrjList.updateViewInfo_deleted */
		
		UPDATE MENU
		SET VIEW_ID = ''
		  , CRTR_ID = #{USER_ID}
		WHERE MENU_ID = #{MENU_ID}
	    AND PRJCT_ID = #{PRJ_ID}
	</update>
	
	<delete id="deleteMenu" parameterType="hashmap">
		/* popPrjList.deleteMenu*/

		DELETE FROM MENU
		WHERE PRJCT_ID = #{PRJCT_ID}
		AND
		MENU_ID NOT IN
		<foreach collection="deleteKey" item="item" open="(" close=")"
			separator=",">
			#{item}
		</foreach>
	</delete>
	
	<select id="prjNmValidate" parameterType="string" resultType="string">
		SELECT 
			CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END 
			FROM T_RE_PRJ_004 
			WHERE PRJCT_NM = #{PRJ_NM}
	</select>
	
</mapper>