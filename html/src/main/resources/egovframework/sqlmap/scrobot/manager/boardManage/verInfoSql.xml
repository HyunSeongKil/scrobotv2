<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="verInfoSql">
	
	<select id="selectVerInfoList" parameterType="Map" resultType ="HashMap">
	<![CDATA[
		SELECT
			S.*
		FROM
			(
				SELECT
					 FORMAT(@ROWNUM := @ROWNUM-1, 0) AS NUMROW
					,BBSCTT_NO	
					,MBR_ID	
					,BBSCTT_TY	
					,BBSCTT_SJ	
					,BBSCTT_CN	
					,(CASE
						WHEN MDFR IS NULL THEN WRTER
						WHEN MDFR IS NOT NULL THEN MDFR
						END
					) WRTER
					,(CASE
						WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
						WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
						END
					) WRT_YMD
					,DEL_YN	
					,VIEWS	
					,POST_FIX_YN	
					,(SELECT COUNT(BBSCTT_NO) FROM MP_FILE B WHERE A.BBSCTT_NO = B.BBSCTT_NO AND DEL_YN = "N") AS MP_FILE_CNT
				FROM
					BBS A
				, 	(select @ROWNUM:=${maxNum}+1) temp
				WHERE
					1=1
				AND
					BBSCTT_TY = 'N03'
				AND
					DEL_YN = "N" 
				ORDER BY WRT_YMD DESC, BBSCTT_NO DESC
			)S
		WHERE 1=1 
		AND NUMROW <=#{maxNum}-(#{pageNum}-1)*10
		AND NUMROW>=#{maxNum}-(#{pageNum}-1)*10-9
	]]>
	</select>
	<select id="selectVerInfoSearchList" parameterType="Map" resultType ="HashMap">
	<![CDATA[
	SELECT  
		D.*
	FROM (
		SELECT
			FORMAT(@ROWNUM := @ROWNUM-1, 0) AS NUMROW 
			, S.*
		FROM
			(SELECT
				BBSCTT_NO	
				,MBR_ID	
				,BBSCTT_TY	
				,BBSCTT_SJ	
				,BBSCTT_CN	
				,(CASE
					WHEN MDFR IS NULL THEN WRTER
					WHEN MDFR IS NOT NULL THEN MDFR
					END
				) WRTER
				,(CASE
					WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
					WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
					END
				) WRT_YMD
				,DEL_YN	
				,VIEWS	
				,POST_FIX_YN	
				,(SELECT COUNT(BBSCTT_NO) FROM MP_FILE B WHERE A.BBSCTT_NO = B.BBSCTT_NO AND DEL_YN = "N") AS MP_FILE_CNT
			FROM
				BBS A
			WHERE
				1=1
			AND
				BBSCTT_TY = 'N03'
			AND
				DEL_YN = "N"
			ORDER BY WRT_YMD DESC, BBSCTT_NO DESC
		)S 
		,(select @ROWNUM:=${maxNum}+1) temp
	WHERE 1=1
	]]>
	<if test="from != null">
	AND 
		<![CDATA[
		DATE_FORMAT(WRT_YMD,'%Y.%m.%d') >= #{from}
		]]>
	</if>
	<if test="to != null">
	AND 
		<![CDATA[
		DATE_FORMAT(WRT_YMD,'%Y.%m.%d') <= #{to}
		]]>
	</if>
	  <if test="SearchStr != null and SearchType != null">
	<if test="SearchType == '전체'">
	AND
	(	BBSCTT_SJ LIKE '%/${SearchStr}%' ESCAPE '/'
	OR
		BBSCTT_CN LIKE '%/${SearchStr}%' ESCAPE '/'
	)
	 </if> 
	 <if test="SearchType == '제목'">
	AND
		BBSCTT_SJ LIKE '%/${SearchStr}%' ESCAPE '/'
	 </if>
	 <if test="SearchType == '내용'">
	AND
		BBSCTT_CN LIKE '%/${SearchStr}%' ESCAPE '/'
	 </if>
	 </if>
	ORDER BY WRT_YMD DESC , BBSCTT_NO DESC
	)D
	<![CDATA[
	WHERE 1=1
	AND NUMROW <=#{maxNum}-(#{pageNum}-1)*10
	AND NUMROW>=#{maxNum}-(#{pageNum}-1)*10-9
	]]>
	
	</select>
	
	<select id="getVerInfoCount" resultType ="Integer">
		SELECT 
			COUNT(*) AS COUNT_NUM 
		FROM
			BBS
		WHERE 
			BBSCTT_TY = "N03" 
		AND 
			DEL_YN = "N"
	</select>
	
	<select id="getVerInfoSearchCount" parameterType="Map" resultType ="Integer">
		<![CDATA[
	SELECT COUNT(*) FROM (
		SELECT
			S.*
		FROM
			(
			SELECT
				 FORMAT(@ROWNUM := @ROWNUM-1, 0) AS NUMROW
				,BBSCTT_NO	
				,MBR_ID	
				,BBSCTT_TY	
				,BBSCTT_SJ	
				,BBSCTT_CN	
				,(CASE
					WHEN MDFR IS NULL THEN WRTER
					WHEN MDFR IS NOT NULL THEN MDFR
					END
				) WRTER
				,(CASE
					WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
					WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
					END
				) WRT_YMD
				,DEL_YN	
				,VIEWS	
				,POST_FIX_YN	
				,(SELECT COUNT(BBSCTT_NO) FROM MP_FILE B WHERE A.BBSCTT_NO = B.BBSCTT_NO AND DEL_YN = "N") AS MP_FILE_CNT
			FROM
				BBS A
				, 	(select @ROWNUM:=	(SELECT
 										COUNT(*)
 									FROM
 										(SELECT 
						 					(CASE
											WHEN MDFR IS NULL THEN WRTER
											WHEN MDFR IS NOT NULL THEN MDFR
											END
											) WRTER
											,(CASE
											WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
											WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
											END
											) WRT_YMD
											, BBSCTT_SJ
											, BBSCTT_CN
										FROM 
											BBS 
										WHERE 1=1
										AND BBSCTT_TY='N03' 
										AND DEL_YN = 'N'
										)AB
									WHERE
										1=1
		]]>
										 <if test="from != null">
	AND 
		<![CDATA[
		DATE_FORMAT(WRT_YMD,'%Y.%m.%d') >= #{from}
		]]>
	</if>
	<if test="to != null">
	AND 
		<![CDATA[
		DATE_FORMAT(WRT_YMD,'%Y.%m.%d') <= #{to}
		]]>
	</if>
	 <if test="SearchStr != null and SearchType != null">
	<if test="SearchType == '전체'">
	AND
	(	BBSCTT_SJ LIKE '%/${SearchStr}%' ESCAPE '/'
	OR
		BBSCTT_CN LIKE '%/${SearchStr}%' ESCAPE '/'
	)
	 </if> 
	 <if test="SearchType == '제목'">
	AND
		BBSCTT_SJ LIKE '%/${SearchStr}%' ESCAPE '/'
	 </if>
	 <if test="SearchType == '내용'">
	AND
		BBSCTT_CN LIKE '%/${SearchStr}%' ESCAPE '/'
	 </if>
	 </if>
		<![CDATA[
							)
							+1) temp
			WHERE
				1=1
			AND
				BBSCTT_TY = 'N03'
			AND
				DEL_YN = "N"
			ORDER BY WRT_YMD DESC , BBSCTT_NO DESC
			)S
			WHERE 
				1=1
		]]>
		 <if test="from != null">
	AND 
		<![CDATA[
		DATE_FORMAT(WRT_YMD,'%Y.%m.%d') >= #{from}
		]]>
	</if>
	<if test="to != null">
	AND 
		<![CDATA[
		DATE_FORMAT(WRT_YMD,'%Y.%m.%d') <= #{to}
		]]>
	</if>
	 <if test="SearchStr != null and SearchType != null">
	<if test="SearchType == '전체'">
	AND
	(	BBSCTT_SJ LIKE '%/${SearchStr}%' ESCAPE '/'
	OR
		BBSCTT_CN LIKE '%/${SearchStr}%' ESCAPE '/'
	)
	 </if> 
	 <if test="SearchType == '제목'">
	AND
		BBSCTT_SJ LIKE '%/${SearchStr}%' ESCAPE '/'
	 </if>
	 <if test="SearchType == '내용'">
	AND
		BBSCTT_CN LIKE '%/${SearchStr}%' ESCAPE '/'
	 </if>
	 </if>
	     )D
	</select>
	
	<select id="selectVerInfoDetail" parameterType="Map" resultType="HashMap">
		SELECT 
			BBSCTT_NO	
			,MBR_ID	
			,BBSCTT_TY	
			,BBSCTT_SJ	
			,BBSCTT_CN	
			,(CASE
				WHEN MDFR IS NULL THEN WRTER
				WHEN MDFR IS NOT NULL THEN MDFR
				END
			) WRTER
			,(CASE
				WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
				WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
				END
			) WRT_YMD
			,DEL_YN	
			,VIEWS	
			,POST_FIX_YN
		FROM
			BBS
		WHERE
			BBSCTT_TY = "N03" 
		AND
			BBSCTT_NO = #{BBSCTT_NO}  
		AND
			DEL_YN = "N"	
	</select>
	
	<select id="selectBeforeAfterVerInfoList" parameterType="Map" resultType ="HashMap">
	SELECT
			S.*
		FROM
			(
				SELECT
					 FORMAT(@ROWNUM := @ROWNUM-1, 0) AS NUMROW
					,BBSCTT_NO	
					,MBR_ID	
					,BBSCTT_TY	
					,BBSCTT_SJ	
					,BBSCTT_CN	
					,(CASE
						WHEN MDFR IS NULL THEN WRTER
						WHEN MDFR IS NOT NULL THEN MDFR
						END
					) WRTER
					,(CASE
						WHEN MDFCN_YMD IS NULL THEN DATE_FORMAT(WRT_YMD,'%Y.%m.%d')
						WHEN MDFCN_YMD IS NOT NULL THEN DATE_FORMAT(MDFCN_YMD,'%Y.%m.%d')
						END
					) WRT_YMD
					,DEL_YN	
					,VIEWS	
					,POST_FIX_YN	
					,(SELECT COUNT(BBSCTT_NO) FROM MP_FILE B WHERE A.BBSCTT_NO = B.BBSCTT_NO AND DEL_YN = "N") AS MP_FILE_CNT
				FROM
					BBS A
				, 	(select @ROWNUM:=${maxNum}+1) temp
				WHERE
					1=1
				AND
					BBSCTT_TY = 'N03'
				AND
					DEL_YN = "N" 
				ORDER BY WRT_YMD DESC, BBSCTT_NO DESC
			)S
	WHERE 1=1
	AND NUMROW BETWEEN #{MINNUMROW} AND #{ADDNUMROW}
    AND NUMROW NOT IN (#{NUMROW})
	</select>
	
	<select id="updateVerInfoViews" parameterType="Map">
		UPDATE BBS SET VIEWS = #{VIEWS} WHERE BBSCTT_NO = #{BBSCTT_NO} 
	</select>
	
	<select id="getBBSCount" resultType="Integer">
		SELECT COUNT(*)+1 FROM BBS
	</select>
	
	<insert id="insertVerInfo" parameterType="Map">
		INSERT INTO BBS VALUES
		(
		 #{BBSCTT_NO}
		,#{MBR_ID}
		,#{BBSCTT_TY}
		,#{BBSCTT_SJ}
		,#{BBSCTT_CN}
		,#{MBR_NM}
		,SYSDATE()
		,NULL
		,NULL
		,"N"
		,0
		,#{POST_FIX_YN}
		)
	</insert>
	
	<select id="getMpFileCount" resultType="Integer">
		SELECT COUNT(*)+1 FROM MP_FILE
	</select>
	
	<insert id="FileUpload" parameterType="Map">
		INSERT INTO MP_FILE
		VALUES
		(
		#{mpFileCnt}
		,#{BBSCTT_NO}
		,#{oriFileNm}
		,#{saveFileNm}
		,#{fileSize}
		,SYSDATE()
		,NULL
		)
	</insert>
	
	<update id="deleteVerInfo" parameterType="Map">
		UPDATE BBS SET DEL_YN = "Y" WHERE BBSCTT_TY = #{BBSCTT_TY} AND BBSCTT_NO = #{BBSCTT_NO}
	</update>

	<update id="deleteVerInfoMpFile" parameterType="Map">
		UPDATE MP_FILE SET DEL_YN = "Y" WHERE BBSCTT_NO = #{BBSCTT_NO}
	</update>
	
	<update id="updateVerInfo" parameterType="Map">
		UPDATE 
			BBS 
		SET
			BBSCTT_SJ = #{BBSCTT_SJ} 
		,	WRTER = #{WRTER} 
		,	BBSCTT_CN = #{BBSCTT_CN}
		,	POST_FIX_YN = #{POST_FIX_YN} 
		,	MDFR = #{MDFR}
		,	MDFCN_YMD = SYSDATE()
		,	DEL_YN = "N"
		WHERE 
			BBSCTT_NO = #{BBSCTT_NO}
	</update>

	
</mapper>














